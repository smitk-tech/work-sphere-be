#!/bin/sh

echo "üîç Validating commit message..."

# Get the commit message from the file
COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge"; then
  echo "‚úÖ Merge commit detected. Skipping validation."
  exit 0
fi

# Skip revert commits
if echo "$COMMIT_MSG" | grep -qE "^Revert"; then
  echo "‚úÖ Revert commit detected. Skipping validation."
  exit 0
fi

# Commit message pattern: <type>: Descriptive msg
# Types: feature, bugfix, hotfix, refactor, chore, docs, test, fix, feat
COMMIT_PATTERN="^(feature|bugfix|hotfix|refactor|chore|docs|test|fix|feat): .+$"

if ! echo "$COMMIT_MSG" | head -n 1 | grep -qE "$COMMIT_PATTERN"; then
  echo ""
  echo "‚ùå Invalid commit message:"
  echo "   \"$(echo "$COMMIT_MSG" | head -n 1)\""
  echo ""
  echo "Commit message must follow the pattern:"
  echo "  <type>: Descriptive message"
  echo ""
  echo "Where:"
  echo "  ‚Ä¢ type: feature | bugfix | hotfix | refactor | chore | docs | test | fix | feat"
  echo "  ‚Ä¢ Descriptive message: A clear description of the change"
  echo ""
  echo "Examples:"
  echo "  ‚úì bugfix: fix fetch team details api"
  echo "  ‚úì feature: add stripe express onboarding"
  echo "  ‚úì refactor: optimize database queries"
  echo "  ‚úì chore: update dependencies"
  echo "  ‚úì docs: update api documentation"
  echo "  ‚úì test: add integration tests for payment"
  echo ""
  exit 1
fi

echo "‚úÖ Commit message is valid!"

# Run Gerrit's commit-msg hook to generate the Change-Id (if exists)
if [ -f ".git/hooks/commit-msg" ]; then
  .git/hooks/commit-msg "$@"
fi
